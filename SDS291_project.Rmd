---
title: "SDS 291 Data Appendix"
author: "Isabel Gomez, Ester Zhao, Karina Lieb"
date: "March 20, 2019"
output: html_document
---

```{r}
#Load packages
# knitr settings to control how R chunks work and how the pdf is compiled when knit.
# install.packages("readr")
library(readr)
library(mosaic)
require(knitr)
opts_chunk$set(
  tidy=TRUE,                     # display code as typed
  size="small",                   # slightly smaller font for code
  tidy.opts=list(width.cutoff=65), # wrap text and long comments
  fig.width=7, fig.height=5           #figure size
)
require(magrittr)
require(tidyverse)
```

###Data wrangling
```{r}
#First load ipums
library(ipumsr)

# Note that you can pass in the loaded DDI into the library(read_ipums_micro()`
nhis_ddi <- read_ipums_ddi("nhis_00002.xml")

nhis_data <- read_ipums_micro(nhis_ddi, verbose = FALSE)
View(nhis_data)

#Finding the variables that have a label
nhis_data %>%
  select_if(is.labelled)

# Convert the labels to factors (and drop the unused levels) and filter for only 2017
nhis_data<-nhis_data%>%
  mutate(FSRAWSCORE = droplevels(as_factor(FSRAWSCORE)),
         REGION = droplevels(as_factor(REGION)),
         RACE = droplevels(as_factor(RACEBR)))

#Filter for only 2017
nhis_data <- nhis_data %>%
  filter(YEAR == 2017)

```

```{r}
#Filter GOTSTAMPFAM to only include those who answered "Yes" Filter for those only who received SNAP benefits

#GOTSTAMPFAM Codes: 10 = NO, 21 = Yes in last calendar year, 22 = Yes in last month.
#This will remove all observations where GOTSTAMPFAM does not equal 21 or 22
nhis_data<-nhis_data %>%
  filter(GOTSTAMPFAM==21 | GOTSTAMPFAM==22)

```


```{r}
#Convert FSRAWSCORE into a categorical variable, called FoodSecurity, with 3 levels: Secure (0-2), Low Food Security(3-5), Very Low Food Security (6-10). 

#FSRAWSCORE Codes: 

nhis_data<- nhis_data %>%
  mutate(Food_Security = if_else(FSRAWSCORE %in% c(0,1,2), "Secure",
                            if_else(FSRAWSCORE %in% c(3,4,5), "Low Food Security ", 
                                    "Very Low Food Security"))) %>%
  mutate(FOOD_SECURITY=as.factor(Food_Security))
```


```{r}
#---------- WRANGLE CONFOUNDING VARIABLES -------------

#REGION: a categorical variable with string labels as values.

#AGE: A numerical variable indicating age of the individual surveyed.

#EDUC: Create a categorical variable education, with three levels. Did not graduate high school (0), high school graduate or GED (1), vocational degree (2), bachelor's degree/higher (3).
nhis_data<-nhis_data %>%
  mutate(education=if_else(EDUC %in% c(500, 601, 602, 603), 3, #bachelor's or higher
                           if_else(EDUC %in% c(402, 403), 2, #vocational degree
                                   if_else(EDUC %in% c(301, 302, 401), 1, 0)))) %>%
    mutate(EDUCATION=as.factor(education))#high school or GED. Includes college drop outs.
                                  #else, set to 0 (did not complete high school)
  



#RACE: Has been set to labels. Filter out those who chose not to answer race.
nhis_data<-nhis_data %>%
  filter(RACE != "Unknown-refused" | RACE != "Unknown-not ascertained" | RACE != "Unknown-don't know") 
  
  
  #INCOME: Make into a categorical variable. Low-Income includes any family making $0 - $49,999, Middle-Income includes any family making $50,000 - $99,999. High-Income families include any family make more than $100,000
nhis_data<-nhis_data %>%
  mutate(Fam_Income=if_else(INCFAM07ON %in% c(10,11,12), "Low Income",
                            if_else(INCFAM07ON %in% c(21,22,23), "Middle Income",
                                    if_else(INCFAM07ON %in% c(96,99), "N/A", "High Income")))) %>%
  mutate(FAM_INCOME=as.factor(Fam_Income))

#For Income, do we want remove the undefined and unknown, re-labelled as N/A. 

  #HEALTH: Make into a binary inducator variable Health_Issues, which has a value of (0) if the individual is healthy (Code 1-3), and a value of (1) if the individual has fair to poor health (Code 4-5). Give a patch fix value of (2) to all other values for now.
 nhis_data <- nhis_data %>%
   filter(HEALTH %in% c(1,2,3,4,5))
   
nhis_data <- nhis_data %>%
   mutate(Health_Issues=if_else(HEALTH %in% c(1,2,3), 0, 1)) %>% #0 = health, 1= poor
   mutate(HEALTH_ISSUES = as.factor(Health_Issues))

   
  
  #NCHILD: already contains total number of children. Cap at 9 total. The max amount of children in the data is 7. Could we also treat this as numeric.
 
  
  #FAMOLDNO: number of persons in the household aged 65 or older. Data collection cap at 5 total. The max amount elders in our data is just 3. 
  
  #NUMPREC: number of individuals in the household total. "A 3 digit numeric value". Should we categorize this or should we just keep this as numeric as well. How much does it matter the formatting of the confounding variables? 
 
 #GOTSTAMPFAM: Mutate into a factor RECEIVED_STAMPS with two levels, "YES" or "NO"
  nhis_data <- nhis_data %>%
    mutate(Received_Stamps = if_else(GOTSTAMPFAM %in% c(21,22,20), "Yes", "No")) %>%
    mutate(RECEIVED_STAMPS=as.factor(Received_Stamps))
```


#Select only the variables we'll need for analysis 
```{r}
nhis_data <- nhis_data %>%
  select(AGE, FOOD_SECURITY, NCHILD, NUMPREC, FAMOLDNO, HEALTH_ISSUES, RACE, EDUCATION, FAM_INCOME, REGION, RECEIVED_STAMPS)
```


<!-- --------------------------------------------------- -->

#Structure and Names

```{r}
str(nhis_data, give.attr = FALSE)
```

There are 11 variables in the data we are using, and 10926 observations. The variables are:

1. `AGE` states the surveyed individual's age (number)
2. `FOOD_SECURITY` states the household's food security as a categorical variable with 3 levels, "Very Food Insecure", "Food Insecure", and "Secure".
3. `NCHILD` states how many children have been born to the household in the last year (number)
4. `NUMPREC` states how many individuals total live in the household (number)
5. `FAMOLDNO` states how many individuals over the age of 65 are within the household. (number)
6. `HEALTH_ISSUES` is a binary indicator variable that states whether an individual is healthy (HEALTH_ISSUES=0), or has health issues (HEALTH_ISSUES=1).
7. `RACE` states the race of the individual surveyed as a categorical variable with 8 levels.
8. `EDUCATION` states the highest level of education the surveyed individual received, as a categorical variable with 4 levels.
9. `FAM_INCOME` states the income level of the household as a categorical variable with 4 levels. 
10. `REGION` states the region of the US in which the household is located, as a categorical variable with 5 levels.
11. `RECEIVED_STAMPS` states whether or not the household used Food Stamps within the last year, and we have filtered out those households which did not use Food Stamps in the last year.

#Variable analysis

```{r}
favstats(~AGE, data=nhis_data)
```

The minimum age is 0, which is logical because it includes small children. The maximum is 85 - we may have expected the maximum to be a bit higher, but this is also reasonable. The mean age is 31, which also seems reasonable when surveying households. 
```{r}
tally(~FOOD_SECURITY, data = nhis_data)

```

We see here that from families that participated in SNAP, about 13.51% reported having Very Low Food Security, 16.13% reported having Low Food Security, and 70.36% reported feeling Food Secure. This seems fairly in line with our expectations, as the majority of families that particpated in SNAP are reporting that the system worked well for them, while a percentage reported a lower success rate.



